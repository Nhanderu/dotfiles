#!/usr/bin/env bash

PROJECT_NAME="$1"
BRANCH_NAME="$2"

BUILD_RESULT=`aws --region us-east-1 codebuild start-build --project-name "$PROJECT_NAME" --source-version "$BRANCH_NAME" | tr '\n' ' ' | tr '\t' ' '`
BUILD_ID=`echo $BUILD_RESULT | sed -E 's/.*"id": "([^"]*)".*/\1/g'`

BUILD_COMPLETE="false"
while [[ "$BUILD_COMPLETE" != "true" ]]; do

    LIST_RESULT=`aws --region us-east-1 codebuild batch-get-builds --ids $BUILD_ID | tr '\n' ' ' | tr '\t' ' '`
    BUILD_COMPLETE=`echo $LIST_RESULT | sed -E 's/.*"buildComplete": ([a-z]*).*/\1/g'`
    BUILD_STATUS=`echo $LIST_RESULT | sed -E 's/.*"buildStatus": "([^"]*)".*/\1/g'`
    echo "Current status: $BUILD_STATUS"
    sleep 2

done

echo
echo
echo "Finished with status: $BUILD_STATUS"
